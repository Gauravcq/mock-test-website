<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>My Profile</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Inter,Arial;background:#f4f6fb;margin:0;padding:30px}
    .card{max-width:520px;margin:24px auto;background:#fff;padding:22px;border-radius:12px;box-shadow:0 8px 30px rgba(20,20,50,.06)}
    .center{text-align:center}
    .avatar{width:120px;height:120px;border-radius:50%;object-fit:cover;border:4px solid #6a0eff;cursor:pointer}
    input{width:100%;padding:10px;margin:10px 0;border-radius:8px;border:1px solid #ddd;font-size:15px}
    .btn{width:100%;padding:12px;background:#6a0eff;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:700;margin-top:12px}
  </style>
</head>
<body>

<div class="card">
  <div class="center">
    <img id="profilePic" class="avatar" src="avatar.png"" alt="avatar" title="Click to change">
    <input id="avatarInput" type="file" accept="image/*" style="display:none" />
    <h2 id="titleName">User</h2>
    <p id="emailDisplay" style="color:#6b7280;margin-top:6px"></p>
  </div>

  <div style="margin-top:12px">
    <label>Name</label>
    <input id="name" type="text" />
    <label>Email</label>
    <input id="email" type="email" />
    <label>Mobile</label>
    <input id="mobile" type="text" />
    <button id="saveBtn" class="btn">Save Profile</button>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', ()=>{
  const users = JSON.parse(localStorage.getItem('mock-users') || '[]');
  const current = JSON.parse(localStorage.getItem('mock-current-user') || 'null');

  if (!current) {
    window.location.href = 'login.html';
    return;
  }

  // populate
  document.getElementById('profilePic').src = current.avatar || 'https://i.ibb.co/2Kq8q1V/user.png';
  document.getElementById('titleName').textContent = current.name;
  document.getElementById('emailDisplay').textContent = current.email;

  document.getElementById('name').value = current.name;
  document.getElementById('email').value = current.email;
  document.getElementById('mobile').value = current.mobile || '';

  // avatar click / upload
  const avatar = document.getElementById('profilePic');
  const avatarInput = document.getElementById('avatarInput');

  avatar.addEventListener('click', ()=> avatarInput.click());

  avatarInput.addEventListener('change', (ev) => {
    const file = ev.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(){
      avatar.src = reader.result;
      // update local variable - we'll save when user clicks Save
      avatar.dataset.pending = reader.result;
    };
    reader.readAsDataURL(file);
  });

  // Save
  document.getElementById('saveBtn').addEventListener('click', ()=>{
    const name = document.getElementById('name').value.trim();
    const email = document.getElementById('email').value.trim().toLowerCase();
    const mobile = document.getElementById('mobile').value.trim();

    if (!name || !email) { alert('Name & email required'); return; }

    // fetch users and find current user index (by id or original email)
    const all = JSON.parse(localStorage.getItem('mock-users') || '[]');

    // find the user's index using current email (before edit)
    const idx = all.findIndex(u => u.email === current.email);
    if (idx === -1) { alert('User not found'); return; }

    // unique email check
if (
    email !== current.email &&
    all.some((u, i) => i !== idx && u.email === email)
) {
    alert("Email already in use by another account.");
    return;
}

// unique mobile check
if (
    mobile !== current.mobile &&
    mobile &&
    all.some((u, i) => i !== idx && u.mobile === mobile)
) {
    alert("Mobile number already in use by another account.");
    return;
}


    // apply avatar if uploaded
    const newAvatar = avatar.dataset.pending ? avatar.dataset.pending : (current.avatar || null);

    const updated = Object.assign({}, all[idx], {
      name, email, mobile, avatar: newAvatar
    });

    all[idx] = updated;
    // save users and update current user
    localStorage.setItem('mock-users', JSON.stringify(all));
    localStorage.setItem('mock-current-user', JSON.stringify(updated));
    alert('Profile saved.');
    window.location.href = 'index.html';
  });
});
</script>

</body>
</html>
